// Prisma Schema for Unix Team Platform
// Comprehensive database model with security features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String?
  firstName         String
  lastName          String
  avatar            String?
  phone             String?
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  mfaEnabled        Boolean   @default(false)
  mfaSecret         String?   // Encrypted TOTP secret
  lastLogin         DateTime?
  failedLoginCount  Int       @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete for data retention

  // Relations
  roles             UserRole[]
  teamMemberships   TeamMember[]
  auditLogs         AuditLog[]
  sessions          Session[]
  oauthConnections  OAuthConnection[]
  githubProfile     GitHubProfile?
  notifications     Notification[]
  dataExportRequests DataExportRequest[]

  @@index([email])
  @@index([isActive])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // admin, hr_manager, team_lead, member, viewer
  description String?
  permissions String[] // Array of permission strings
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       UserRole[]
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  grantedBy String?
  grantedAt DateTime @default(now())
  expiresAt DateTime?

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  isValid      Boolean  @default(true)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model OAuthConnection {
  id           String   @id @default(uuid())
  userId       String
  provider     String   // google, github
  providerId   String
  accessToken  String   // Encrypted
  refreshToken String?  // Encrypted
  expiresAt    DateTime?
  scope        String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

// ============================================
// TEAM MANAGEMENT
// ============================================

model Team {
  id           String   @id @default(uuid())
  name         String
  description  String?
  avatar       String?
  department   String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  // Relations
  members      TeamMember[]
  projects     Project[]
  documents    Document[]

  @@index([name])
}

model TeamMember {
  id        String     @id @default(uuid())
  teamId    String
  userId    String
  role      TeamRole   @default(MEMBER)
  joinedAt  DateTime   @default(now())
  leftAt    DateTime?

  // Relations
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

enum TeamRole {
  OWNER
  LEAD
  MEMBER
  VIEWER
}

// ============================================
// PROJECT MANAGEMENT
// ============================================

model Project {
  id              String        @id @default(uuid())
  teamId          String
  name            String
  description     String?
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime?
  endDate         DateTime?
  budget          Decimal?      @db.Decimal(12, 2)
  technologies    String[]
  repositoryUrl   String?
  documentationUrl String?
  isPublic        Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  // Relations
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  githubRepos     ProjectGitHubRepo[]
  aiAnalyses      ProjectAIAnalysis[]
  documents       Document[]

  @@index([teamId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectGitHubRepo {
  id          String   @id @default(uuid())
  projectId   String
  repoOwner   String
  repoName    String
  repoUrl     String
  isPrivate   Boolean  @default(false)
  stars       Int      @default(0)
  forks       Int      @default(0)
  language    String?
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, repoOwner, repoName])
}

// ============================================
// GITHUB INTEGRATION
// ============================================

model GitHubProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  username        String   @unique
  profileUrl      String
  avatarUrl       String?
  bio             String?
  company         String?
  location        String?
  publicRepos     Int      @default(0)
  followers       Int      @default(0)
  following       Int      @default(0)
  contributions   Int      @default(0)
  topLanguages    String[]
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// AI ANALYSIS FOR HR
// ============================================

model ProjectAIAnalysis {
  id                    String   @id @default(uuid())
  projectId             String
  analysisType          String   // usefulness, beneficiaries, risk, skills
  summary               String   @db.Text
  usefulnessScore       Int?     // 1-100
  targetBeneficiaries   String[] // departments, roles that benefit
  businessImpact        String?  @db.Text
  requiredSkills        String[]
  estimatedROI          String?
  recommendations       String[] 
  riskAssessment        String?  @db.Text
  aiModel               String   // Model used for analysis
  confidence            Float?   // AI confidence score
  analyzedBy            String?  // User who triggered analysis
  createdAt             DateTime @default(now())
  expiresAt             DateTime // Analysis validity period

  // Relations
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================
// DOCUMENT MANAGEMENT (Excel, Google Docs)
// ============================================

model Document {
  id              String       @id @default(uuid())
  teamId          String?
  projectId       String?
  name            String
  type            DocumentType
  sourceType      SourceType
  sourceId        String?      // Google Doc ID or file path
  sourceUrl       String?
  mimeType        String?
  size            Int?
  checksum        String?      // For integrity verification
  encryptedPath   String?      // Encrypted local storage path
  lastSyncAt      DateTime?
  createdBy       String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?

  // Relations
  team            Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  project         Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  versions        DocumentVersion[]

  @@index([teamId])
  @@index([projectId])
  @@index([sourceType])
}

enum DocumentType {
  SPREADSHEET
  DOCUMENT
  PRESENTATION
  PDF
  OTHER
}

enum SourceType {
  EXCEL_LOCAL
  EXCEL_SHAREPOINT
  GOOGLE_DOCS
  GOOGLE_SHEETS
  UPLOAD
}

model DocumentVersion {
  id          String   @id @default(uuid())
  documentId  String
  version     Int
  changes     String?  @db.Text
  checksum    String
  createdBy   String
  createdAt   DateTime @default(now())

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id           String     @id @default(uuid())
  userId       String?
  action       String     // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  resource     String     // Resource type affected
  resourceId   String?    // Resource ID affected
  details      Json?      // Additional details
  ipAddress    String?
  userAgent    String?
  status       AuditStatus @default(SUCCESS)
  errorMessage String?
  duration     Int?       // Action duration in ms
  createdAt    DateTime   @default(now())

  // Relations
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

enum AuditStatus {
  SUCCESS
  FAILURE
  WARNING
}

model SecurityIncident {
  id           String         @id @default(uuid())
  type         IncidentType
  severity     Severity
  title        String
  description  String         @db.Text
  affectedUsers String[]
  affectedResources String[]
  status       IncidentStatus @default(OPEN)
  detectedAt   DateTime       @default(now())
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?        @db.Text
  preventiveMeasures String?  @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
}

enum IncidentType {
  UNAUTHORIZED_ACCESS
  DATA_BREACH
  BRUTE_FORCE
  SUSPICIOUS_ACTIVITY
  POLICY_VIOLATION
  SYSTEM_COMPROMISE
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  CONTAINED
  RESOLVED
  CLOSED
}

// ============================================
// DATA PROTECTION & COMPLIANCE
// ============================================

model DataExportRequest {
  id          String            @id @default(uuid())
  userId      String
  type        ExportType
  status      ExportStatus      @default(PENDING)
  requestedAt DateTime          @default(now())
  processedAt DateTime?
  downloadUrl String?           // Encrypted, temporary URL
  expiresAt   DateTime?
  
  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

enum ExportType {
  GDPR_EXPORT      // Full data export
  GDPR_DELETE      // Right to be forgotten
  AUDIT_REPORT
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

model CompliancePolicy {
  id          String   @id @default(uuid())
  name        String   @unique
  description String   @db.Text
  type        String   // GDPR, SOC2, ISO27001, etc.
  rules       Json     // Policy rules in JSON format
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  SYSTEM
  SECURITY
  PROJECT
  TEAM
  AI_ANALYSIS
  HR_SUGGESTION
}
